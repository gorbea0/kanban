<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kanban local + GitHub JSON (Vanilla) ‚Äî Meses coloreados + Lista fix</title>
<style>
  :root{
    --bg:#f7fafc; --card:#fff; --muted:#6b7280; --primary:#3b82f6; --border:#e5e7eb;
    --pendiente:#64748b; --iniciado:#3b82f6; --enviado:#22c55e; --calificado:#a855f7;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial; background:linear-gradient(#f8fafc,#ffffff);} 
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
  .title{display:flex;gap:10px;align-items:center}
  .badge{background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:6px;box-shadow: 0 1px 0 rgba(0,0,0,.02)}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .container{max-width:1200px;margin:0 auto;padding:0 16px 32px;display:grid;grid-template-columns: 1fr 300px;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card h3{margin:0 0 8px 0}
  .pad{padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input, select, textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:#fff}
  .tab.active{background:#111827;color:#fff;border-color:#111827}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .col{background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:10px;min-height:220px}
  .col h4{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px 0;font-size:14px}
  .item{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;margin:8px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .item .meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}
  .labels{display:flex;gap:6px;flex-wrap:wrap}
  .label{font-size:12px;border-radius:999px;padding:4px 8px;color:#fff}
  .list table{width:100%;border-collapse:collapse}
  .list th,.list td{border-bottom:1px solid var(--border);text-align:left;padding:8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:13px}
  .cal-cell{min-height:90px;border:1px solid var(--border);border-radius:10px;background:#fff;padding:6px}
  .muted{color:var(--muted)}
  .ring{display:inline-block}
  .flex{display:flex;gap:8px;align-items:center}
  .spacer{flex:1}
  .pill{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .hidden{display:none}
  dialog{border:none;border-radius:16px;width:min(680px,calc(100vw - 32px));}
  dialog::backdrop{background:rgba(0,0,0,.15)}
  /* Meses con fondo alterno para separar visualmente */
  .monthbox{border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
  .monthbox.alt1{background:#f0f7ff}
  .monthbox.alt2{background:#fff7ed}
  .monthbox.alt3{background:#f5fff8}
</style>
</head>
<body>
  <header>
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13"/><rect x="3" y="4" width="3" height="4" rx="1"/><rect x="3" y="10" width="3" height="4" rx="1"/><rect x="3" y="16" width="3" height="4" rx="1"/></svg>
      <h1 style="margin:0;font-size:20px">Kanban local + GitHub JSON</h1>
      <span class="badge">ES</span>
      <span id="msg" class="muted"></span>
    </div>
    <div class="row">
      <button class="btn" id="btnExport">Exportar JSON</button>
      <button class="btn" id="btnLoad">Cargar JSON</button>
      <button class="btn primary" id="btnSave">Guardar JSON</button>
    </div>
  </header>

  <div class="container">
    <div class="card pad" id="main">
      <div class="toolbar">
        <select id="boardSel"></select>
        <button class="btn" id="btnNewBoard">+ Tablero</button>
        <button class="btn" id="btnRenameBoard">Renombrar</button>
        <button class="btn" id="btnDeleteBoard">Eliminar</button>
        <div class="spacer"></div>
        <input id="search" placeholder="Buscar..." style="width:220px"/>
        <select id="estadoFilter"><option value>Estado</option></select>
        <select id="labelFilter"><option value>Etiqueta</option></select>
      </div>

      <div class="tabs" style="margin-top:10px">
        <button class="tab active" data-tab="kanban">Kanban</button>
        <button class="tab" data-tab="lista">Lista</button>
        <button class="tab" data-tab="cal">Calendario</button>
      </div>

      <section id="view-kanban" style="margin-top:10px">
        <div class="grid-4" id="kanbanCols"></div>
      </section>

      <section id="view-lista" class="list hidden" style="margin-top:10px">
        <table>
          <thead><tr><th>T√≠tulo</th><th>Estado</th><th>Etiquetas</th><th>Vence</th><th>D√≠as</th><th></th></tr></thead>
          <tbody id="listTbody"></tbody>
        </table>
      </section>

      <section id="view-cal" class="hidden" style="margin-top:10px">
        <div class="row">
          <select id="calSpan">
            <option value="mensual">Mensual</option>
            <option value="trimestral">Trimestral</option>
            <option value="cuatrimestral">Cuatrimestral</option>
            <option value="anual">Anual</option>
          </select>
          <button class="btn" id="calPrev">‚óÄ</button>
          <button class="btn" id="calNext">‚ñ∂</button>
          <div id="calTitle" class="pill"></div>
        </div>
        <div id="calWrap" style="margin-top:10px"></div>
      </section>
    </div>

    <aside class="card pad">
      <h3>Etiquetas</h3>
      <div id="labelsWrap" class="labels" style="margin-bottom:8px"></div>
      <div class="row">
        <input id="newLabelName" placeholder="Nombre de etiqueta" />
        <input id="newLabelColor" type="color" value="#3b82f6" style="width:60px;padding:4px"/>
        <button class="btn" id="btnAddLabel">A√±adir</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <h3>Nueva tarea</h3>
      <button class="btn" id="btnNew">+ Tarea</button>

      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <h3>GitHub</h3>
      <div class="row">
        <input id="ghOwner" placeholder="Owner"/>
        <input id="ghRepo" placeholder="Repo"/>
        <input id="ghBranch" placeholder="Rama (main)"/>
        <input id="ghPath" placeholder="Ruta (kanban.json)"/>
        <input id="ghToken" placeholder="Token (PAT)"/>
      </div>
    </aside>
  </div>

  <dialog id="itemDlg">
    <form method="dialog" id="itemForm" class="pad">
      <h3 id="dlgTitle">Tarea</h3>
      <div class="row">
        <div style="flex:1">
          <label>T√≠tulo<input id="itTitulo"></label>
        </div>
        <div style="width:180px">
          <label>Estado<select id="itEstado"></select></label>
        </div>
      </div>
      <label>Descripci√≥n<textarea id="itDesc" rows="5"></textarea></label>
      <div class="row">
        <div style="width:180px"><label>Vencimiento<input type="date" id="itDue"></label></div>
        <div style="flex:1"><label>Icono
          <select id="itIcon"></select>
        </label></div>
      </div>
      <div>
        <div class="muted" id="itDueInfo"></div>
      </div>
      <div style="margin-top:8px">
        <div>Etiquetas</div>
        <div id="itLabels" class="labels"></div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn ghost" value="cancel">Cancelar</button>
        <button class="btn primary" id="btnSaveItem" value="default">Guardar</button>
      </div>
    </form>
  </dialog>

<script>
const LS_KEY = 'kanban-vanilla';
const ESTADOS = [
  {id:'pendiente', nombre:'Pendiente', color:'var(--pendiente)'},
  {id:'iniciado', nombre:'Iniciado', color:'var(--iniciado)'},
  {id:'enviado', nombre:'Enviado', color:'var(--enviado)'},
  {id:'calificado', nombre:'Calificado', color:'var(--calificado)'}
];
const ICONOS = ['üìÑ','üìù','üì¶','‚úÖ','‚è∞','üêõ','‚≠ê','üöÄ','üìß','üîß','üí°','üìÖ','üìå','üóÇÔ∏è','üß™'];
const PALETA = ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#10b981','#06b6d4','#3b82f6','#6366f1','#8b5cf6','#ec4899','#f43f5e','#64748b','#94a3b8','#111827','#000000'];

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function startOfDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())}
function ymdLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}` }
function todayYMD(){return ymdLocal(new Date())}
function daysUntil(ymd){ if(!ymd) return null; const d=new Date(ymd+"T00:00:00"); const now=startOfDay(new Date()); const diff=d - now; return Math.ceil(diff/86400000) }
function formatDateES(ymd){ if(!ymd) return ''; const dt=new Date(ymd+"T00:00:00"); const dd=String(dt.getDate()).padStart(2,'0'); const mm=String(dt.getMonth()+1).padStart(2,'0'); const yyyy=dt.getFullYear(); return `${dd}-${mm}-${yyyy}` }

function msg(t){const el=document.getElementById('msg'); el.textContent=t; if(t) setTimeout(()=> el.textContent='', 2000)}
function b64e(s){return btoa(unescape(encodeURIComponent(s)))}
function b64d(s){return decodeURIComponent(escape(atob(s)))}

const defaultData = {version:1, labels:[{id:'urgente',nombre:'Urgente',color:'#ef4444'},{id:'bug',nombre:'Bug',color:'#f59e0b'},{id:'mejora',nombre:'Mejora',color:'#22c55e'}], boards:[{id:'general',nombre:'General',color:'#3b82f6',columnas:ESTADOS.map(e=>e.id)}], items:[{id:uid(),boardId:'general',titulo:'¬°Bienvenido!',descripcion:'Edita, arrastra y suelta.',estado:'pendiente',etiquetas:['mejora'],vencimiento:todayYMD(),icono:'üìÑ',orden:0,creadoAt:new Date().toISOString()}]};

function loadLocal(){try{const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):defaultData}catch(e){return defaultData}}
function saveLocal(d){localStorage.setItem(LS_KEY, JSON.stringify(d))}

// GitHub cfg
const gh = JSON.parse(localStorage.getItem(LS_KEY+':github')||'{}');
['ghOwner','ghRepo','ghBranch','ghPath','ghToken'].forEach(id=>{const el=document.getElementById(id); if(el) el.value = gh[id]||''});
function saveGhCfg(){const cfg={owner:ghOwner.value,repo:ghRepo.value,branch:ghBranch.value||'main',path:ghPath.value||'kanban.json',token:ghToken.value||''}; localStorage.setItem(LS_KEY+':github', JSON.stringify(cfg)); return cfg}

let data = loadLocal();
let state = { boardId: data.boards[0]?.id || 'general', buscar:'', etiquetaFiltro:'', estadoFiltro:'', tab:'kanban', calSpan:'mensual', calRef: {year:new Date().getFullYear(), month:new Date().getMonth()} };

// UI binds
const boardSel = document.getElementById('boardSel');
const estadoFilter = document.getElementById('estadoFilter');
const labelFilter = document.getElementById('labelFilter');
const searchInput = document.getElementById('search');

function renderBoardSelector(){
  boardSel.innerHTML = data.boards.map(b=>`<option value="${b.id}">${b.nombre}</option>`).join('');
  boardSel.value = state.boardId;
}

function renderFilters(){
  estadoFilter.innerHTML = '<option value>Estado</option>'+ ESTADOS.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  estadoFilter.value = state.estadoFiltro;
  labelFilter.innerHTML = '<option value>Etiqueta</option>'+ data.labels.map(l=>`<option value="${l.id}">${l.nombre}</option>`).join('');
  labelFilter.value = state.etiquetaFiltro;
}

function labelById(id){return data.labels.find(l=>l.id===id)}
function estadoColor(id){switch(id){case 'pendiente':return getComputedStyle(document.documentElement).getPropertyValue('--pendiente');case 'iniciado':return getComputedStyle(document.documentElement).getPropertyValue('--iniciado');case 'enviado':return getComputedStyle(document.documentElement).getPropertyValue('--enviado');case 'calificado':return getComputedStyle(document.documentElement).getPropertyValue('--calificado');default:return '#111827'}}

function filteredItems(){
  const q = state.buscar.trim().toLowerCase();
  return data.items.filter(it=> it.boardId===state.boardId && (!q || it.titulo.toLowerCase().includes(q) || (it.descripcion||'').toLowerCase().includes(q)) && (!state.etiquetaFiltro || (it.etiquetas||[]).includes(state.etiquetaFiltro)) && (!state.estadoFiltro || it.estado===state.estadoFiltro));
}

function ringSVG(percent, danger){
  const size=28, stroke=4; const r=(size-stroke)/2; const c=2*Math.PI*r; const dash=Math.max(0,Math.min(100,percent))*c/100; 
  return `<svg class="ring" width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${stroke}" stroke="currentColor" fill="none" opacity=".2"/><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${stroke}" stroke="currentColor" fill="none" stroke-dasharray="${dash} ${c}" transform="rotate(-90 ${size/2} ${size/2})" ${danger?"style='color:#ef4444'":''}/></svg>`
}

function dueBadge(ymd){
  const d = daysUntil(ymd); if(d===null) return '';
  const overdue = d<0, within3 = d<=3 && d>=0; const cls = overdue?"style='background:#fee2e2;border-color:#fecaca;color:#991b1b'": within3?"style='background:#fef9c3;border-color:#fde68a;color:#92400e'":"";
  const pct = overdue?100:(100 - Math.min(30, Math.max(0,d))*(100/30));
  return `<span class='pill' ${cls}>${overdue?`Atrasado ${Math.abs(d)}d`: d===0?"Vence hoy":`${d}d`}</span> ${ringSVG(pct, overdue)}`
}

function renderKanban(){
  const board = data.boards.find(b=>b.id===state.boardId);
  const wrap = document.getElementById('kanbanCols');
  wrap.innerHTML = '';
  board.columnas.forEach(colId=>{
    const colItems = filteredItems().filter(it=> it.estado===colId).sort((a,b)=> a.orden-b.orden);
    const col = document.createElement('div'); col.className='col'; col.dataset.col=colId; col.ondragover = e=> e.preventDefault(); col.ondrop = e=>{ const id=e.dataTransfer.getData('text/plain'); moveItemTo(id,colId) };
    const head = document.createElement('h4'); head.innerHTML = `${ESTADOS.find(e=>e.id===colId).nombre} <span class='muted'>${colItems.length}</span>`; col.appendChild(head);
    const addBtn = document.createElement('button'); addBtn.className='btn ghost'; addBtn.textContent='+'; addBtn.onclick=()=> newItem(); head.appendChild(addBtn);
    colItems.forEach(it=> col.appendChild(renderItemCard(it)) );
    wrap.appendChild(col);
  })
}

function renderItemCard(it){
  const div = document.createElement('div'); div.className='item'; div.draggable=true; div.ondragstart = e=> e.dataTransfer.setData('text/plain', it.id);
  const title = document.createElement('div'); title.style.fontWeight='600'; title.textContent = `${it.icono||''} ${it.titulo}`; div.appendChild(title);
  if(it.descripcion){ const p=document.createElement('div'); p.className='muted'; p.style.fontSize='13px'; p.textContent=it.descripcion; div.appendChild(p) }
  const meta = document.createElement('div'); meta.className='meta';
  const labs = document.createElement('div'); labs.className='labels';
  (it.etiquetas||[]).forEach(id=>{ const l=labelById(id); if(!l) return; const s=document.createElement('span'); s.className='label'; s.style.background=l.color; s.textContent=l.nombre; labs.appendChild(s) })
  meta.appendChild(labs);
  const due = document.createElement('div'); due.innerHTML = dueBadge(it.vencimiento); meta.appendChild(due);
  div.appendChild(meta);
  const actions = document.createElement('div'); actions.className='row'; actions.style.justifyContent='flex-end'; actions.style.marginTop='6px';
  const b1=document.createElement('button'); b1.className='btn ghost'; b1.textContent='Editar'; b1.onclick=()=> editItem(it);
  const b2=document.createElement('button'); b2.className='btn ghost'; b2.textContent='Eliminar'; b2.onclick=()=> deleteItem(it.id);
  actions.append(b1,b2); div.appendChild(actions);
  return div;
}

function renderList(){
  const tbody = document.getElementById('listTbody'); tbody.innerHTML='';
  filteredItems().sort((a,b)=> a.estado.localeCompare(b.estado) || a.orden-b.orden).forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><b>${it.icono||''} ${it.titulo}</b><div class='muted' style='font-size:12px'>${it.descripcion||''}</div></td>`+
    `<td><span class='label' style='background:${estadoColor(it.estado)}'>${ESTADOS.find(e=>e.id===it.estado).nombre}</span></td>`+
    `<td>${(it.etiquetas||[]).map(id=>{ const l=labelById(id); return l?`<span class='label' style='background:${l.color}'>${l.nombre}</span>`:'' }).join(' ')}</td>`+
    `<td>${formatDateES(it.vencimiento)}</td>`+
    `<td>${dueBadge(it.vencimiento)}</td>`+
    `<td style='text-align:right'><button class='btn ghost' onclick='editItemById("${it.id}")'>Editar</button> <button class='btn ghost' onclick='deleteItem("${it.id}")'>Eliminar</button></td>`;
    tbody.appendChild(tr);
  })
}

function monthGrid(year, month, items){
  const first=new Date(year,month,1); const start=(first.getDay()+6)%7; const days=new Date(year,month+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(year,month,d));
  const wrap=document.createElement('div'); wrap.className='calendar';
  ;['L','M','X','J','V','S','D'].forEach(h=>{const hd=document.createElement('div'); hd.textContent=h; hd.className='muted'; hd.style.textAlign='center'; wrap.appendChild(hd)})
  const total=Math.ceil(cells.length/7)*7; for(let i=0;i<total;i++){ const date=cells[i]||null; const cell=document.createElement('div'); cell.className='cal-cell'; if(date){ const ymd=ymdLocal(date); const d=document.createElement('div'); d.className='muted'; d.style.textAlign='right'; d.textContent=date.getDate(); cell.appendChild(d); const todayItems=items.filter(it=>it.vencimiento===ymd); todayItems.slice(0,4).forEach(it=>{ const s=document.createElement('div'); s.className='label'; s.style.background=estadoColor(it.estado); s.textContent=it.titulo; s.style.display='block'; s.style.margin='2px 0'; cell.appendChild(s)}); if(todayItems.length>4){ const m=document.createElement('div'); m.className='muted'; m.style.fontSize='11px'; m.textContent='+'+(todayItems.length-4)+' m√°s'; cell.appendChild(m)} }
    wrap.appendChild(cell) }
  return wrap;
}

function renderCalendar(){
  const wrap=document.getElementById('calWrap'); wrap.innerHTML='';
  const span=document.getElementById('calSpan').value; const ref=state.calRef; const items=filteredItems().filter(it=>it.vencimiento);
  const title = new Intl.DateTimeFormat('es-ES',{month:'long',year:'numeric'})
  const monthBg = (i)=> ['alt1','alt2','alt3'][i%3];
  function titleMonth(y,m){ return title.format(new Date(y,m,1)) }
  if(span==='mensual'){
    document.getElementById('calTitle').textContent = titleMonth(ref.year,ref.month);
    wrap.appendChild(monthGrid(ref.year,ref.month,items));
  } else if(span==='trimestral'){
    document.getElementById('calTitle').textContent = titleMonth(ref.year,ref.month)+' ‚Äì '+titleMonth(ref.month>8?ref.year+1:ref.year,(ref.month+2)%12);
    const g=document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='repeat(3,1fr)'; g.style.gap='12px';
    for(let i=0;i<3;i++){ const y=ref.year+Math.floor((ref.month+i)/12); const m=(ref.month+i)%12; const box=document.createElement('div'); box.className='monthbox '+monthBg(i); const h=document.createElement('div'); h.textContent=titleMonth(y,m); h.style.fontWeight='600'; h.style.margin='6px 0'; box.appendChild(h); box.appendChild(monthGrid(y,m,items)); g.appendChild(box) }
    wrap.appendChild(g);
  } else if(span==='cuatrimestral'){
    document.getElementById('calTitle').textContent = titleMonth(ref.year,ref.month)+' ‚Äì '+titleMonth(ref.month>7?ref.year+1:ref.year,(ref.month+3)%12);
    const g=document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='repeat(2,1fr)'; g.style.gap='12px';
    for(let i=0;i<4;i++){ const y=ref.year+Math.floor((ref.month+i)/12); const m=(ref.month+i)%12; const box=document.createElement('div'); box.className='monthbox '+monthBg(i); const h=document.createElement('div'); h.textContent=titleMonth(y,m); h.style.fontWeight='600'; h.style.margin='6px 0'; box.appendChild(h); box.appendChild(monthGrid(y,m,items)); g.appendChild(box) }
    wrap.appendChild(g);
  } else {
    document.getElementById('calTitle').textContent = String(ref.year);
    const g=document.createElement('div'); g.style.display='grid'; g.style.gridTemplateColumns='repeat(4,1fr)'; g.style.gap='12px';
    for(let i=0;i<12;i++){ const box=document.createElement('div'); box.className='monthbox '+monthBg(i); const h=document.createElement('div'); h.textContent=titleMonth(ref.year,i); h.style.fontWeight='600'; h.style.margin='6px 0'; box.appendChild(h); box.appendChild(monthGrid(ref.year,i,items)); g.appendChild(box) }
    wrap.appendChild(g);
  }
}

function moveItemTo(id, estado){
  const it = data.items.find(x=>x.id===id); if(!it) return; it.estado=estado; it.orden=Date.now(); saveLocal(data); repaint();
}

function newItem(){ editItem({id:uid(), boardId:state.boardId, titulo:'Nueva tarea', descripcion:'', estado:'pendiente', etiquetas:[], vencimiento:todayYMD(), icono:'üìÑ', orden:Date.now(), creadoAt:new Date().toISOString()}) }
function editItemById(id){ const it=data.items.find(x=>x.id===id); if(it) editItem(it) }
function editItem(it){
  const dlg=document.getElementById('itemDlg'); const form=document.getElementById('itemForm');
  document.getElementById('dlgTitle').textContent = it.id? 'Editar tarea' : 'Nueva tarea';
  const itTitulo=document.getElementById('itTitulo'); const itDesc=document.getElementById('itDesc'); const itEstado=document.getElementById('itEstado'); const itDue=document.getElementById('itDue'); const itIcon=document.getElementById('itIcon'); const itLabels=document.getElementById('itLabels'); const itDueInfo=document.getElementById('itDueInfo');
  itTitulo.value=it.titulo||''; itDesc.value=it.descripcion||''; itDue.value=it.vencimiento||'';
  itEstado.innerHTML = ESTADOS.map(e=>`<option value='${e.id}'>${e.nombre}</option>`).join(''); itEstado.value = it.estado;
  itIcon.innerHTML = ICONOS.map(v=>`<option value='${v}'>${v}</option>`).join(''); itIcon.value=it.icono||ICONOS[0];
  function renderEtis(){ itLabels.innerHTML=''; data.labels.forEach(l=>{ const btn=document.createElement('button'); btn.type='button'; btn.className='chip'; btn.style.borderColor=l.color; btn.innerHTML = `<span style='display:inline-block;width:10px;height:10px;border-radius:999px;background:${l.color}'></span> ${l.nombre}`; const active=(it.etiquetas||[]).includes(l.id); if(!active) btn.style.opacity=.6; btn.onclick=()=>{ const set=new Set(it.etiquetas||[]); active? set.delete(l.id): set.add(l.id); it.etiquetas=[...set]; renderEtis() }; itLabels.appendChild(btn) }) }
  renderEtis();
  function refreshDue(){ const d = daysUntil(itDue.value); itDueInfo.textContent = itDue.value ? (d===0?'Vence hoy': (d<0?`Atrasado ${Math.abs(d)} d√≠as`:`Faltan ${d} d√≠as`)) : 'Sin fecha' }
  refreshDue(); itDue.oninput=refreshDue;
  dlg.showModal();
  form.onsubmit = (e)=>{
    e.preventDefault(); dlg.close();
    it.titulo=itTitulo.value; it.descripcion=itDesc.value; it.estado=itEstado.value; it.vencimiento=itDue.value; it.icono=itIcon.value; it.boardId=state.boardId; if(!it.etiquetas) it.etiquetas=[]; 
    const exists = data.items.some(x=>x.id===it.id); if(!exists) data.items.push(it); saveLocal(data); repaint();
  }
}

function deleteItem(id){ if(!confirm('¬øEliminar tarea?')) return; data.items = data.items.filter(x=>x.id!==id); saveLocal(data); repaint() }

// Labels
function renderLabels(){
  const wrap=document.getElementById('labelsWrap'); wrap.innerHTML='';
  data.labels.forEach(l=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.style.borderColor=l.color; chip.style.background='linear-gradient(0deg, '+l.color+'22, #fff)'; chip.innerHTML=`<span style='display:inline-block;width:10px;height:10px;border-radius:999px;background:${l.color}'></span> ${l.nombre}`;
    const del=document.createElement('button'); del.className='btn ghost'; del.textContent='√ó'; del.onclick=()=>{ data.labels=data.labels.filter(x=>x.id!==l.id); data.items=data.items.map(it=>({...it, etiquetas:(it.etiquetas||[]).filter(e=>e!==l.id)})); saveLocal(data); repaint() };
    chip.appendChild(del); wrap.appendChild(chip);
  })
}

document.getElementById('btnAddLabel').onclick = ()=>{
  const name = document.getElementById('newLabelName').value.trim(); if(!name) return;
  const color = document.getElementById('newLabelColor').value || PALETA[0];
  const id = name.toLowerCase().replace(/\s+/g,'-');
  data.labels.push({id,nombre:name,color}); saveLocal(data); document.getElementById('newLabelName').value=''; repaint();
}

// Boards
function addBoard(){ const id=prompt('ID del tablero','nuevo'); if(!id) return; const nombre=prompt('Nombre visible',id)||id; data.boards.push({id,nombre,color:'#3b82f6',columnas:ESTADOS.map(e=>e.id)}); state.boardId=id; saveLocal(data); repaint() }
function renameBoard(){ const b=data.boards.find(b=>b.id===state.boardId); const nombre=prompt('Nuevo nombre',b.nombre); if(!nombre) return; b.nombre=nombre; saveLocal(data); repaint() }
function deleteBoard(){ if(!confirm('¬øEliminar tablero y sus items?')) return; data.items=data.items.filter(it=>it.boardId!==state.boardId); data.boards=data.boards.filter(b=>b.id!==state.boardId); state.boardId=data.boards[0]?.id||'general'; saveLocal(data); repaint() }

// Tabs: ahora renderiza la vista activa al cambiar
Array.from(document.querySelectorAll('.tab')).forEach(btn=> btn.onclick=()=>{
  state.tab=btn.dataset.tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===btn));
  document.getElementById('view-kanban').classList.toggle('hidden', state.tab!=='kanban');
  document.getElementById('view-lista').classList.toggle('hidden', state.tab!=='lista');
  document.getElementById('view-cal').classList.toggle('hidden', state.tab!=='cal');
  if(state.tab==='kanban') renderKanban();
  if(state.tab==='lista') renderList();
  if(state.tab==='cal') renderCalendar();
})

// Calendar controls
calSpan.onchange = ()=>{ state.calSpan=calSpan.value; renderCalendar() }
calPrev.onclick = ()=>{ const m=state.calRef.month, y=state.calRef.year; if(state.calSpan==='mensual') state.calRef = {year: m===0?y-1:y, month:m===0?11:m-1}; else if(state.calSpan==='trimestral') state.calRef = {year: m<3?y-1:y, month:(m+9)%12}; else if(state.calSpan==='cuatrimestral') state.calRef = {year: m<4?y-1:y, month:(m+8)%12}; else state.calRef={year:y-1,month:m}; renderCalendar() }
calNext.onclick = ()=>{ const m=state.calRef.month, y=state.calRef.year; if(state.calSpan==='mensual') state.calRef = {year: m===11?y+1:y, month:m===11?0:m+1}; else if(state.calSpan==='trimestral') state.calRef = {year: m>8?y+1:y, month:(m+3)%12}; else if(state.calSpan==='cuatrimestral') state.calRef = {year: m>7?y+1:y, month:(m+4)%12}; else state.calRef={year:y+1,month:m}; renderCalendar() }

// Filters & search
boardSel.onchange = ()=>{ state.boardId = boardSel.value; repaint() }
estadoFilter.onchange = ()=>{ state.estadoFiltro = estadoFilter.value; repaint() }
labelFilter.onchange = ()=>{ state.etiquetaFiltro = labelFilter.value; repaint() }
searchInput.oninput = ()=>{ state.buscar = searchInput.value; repaint() }

// GitHub load/save
async function ghLoad(){ try{ const cfg=saveGhCfg(); if(!cfg.owner||!cfg.repo||!cfg.path) return alert('Config incompleta'); msg('Descargando desde GitHub...'); const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch||'main')}`; const res=await fetch(url,{headers:{'Accept':'application/vnd.github+json'}}); if(res.status===404) throw new Error('Archivo no encontrado'); if(!res.ok) throw new Error('Error '+res.status); const j=await res.json(); const content=b64d((j.content||'').replace(/\n/g,'')); data=JSON.parse(content); saveLocal(data); state.boardId = data.boards[0]?.id || 'general'; repaint(); msg('Datos cargados ‚úî') }catch(e){ alert(e.message) }}
async function ghSave(){ try{ const cfg=saveGhCfg(); if(!cfg.owner||!cfg.repo||!cfg.path||!cfg.token) return alert('Falta token o config'); msg('Guardando en GitHub...'); const get=await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}?ref=${encodeURIComponent(cfg.branch||'main')}`,{headers:{'Accept':'application/vnd.github+json'}}); let sha=''; if(get.ok){ const j=await get.json(); sha=j.sha||'' }
  const body={ message:`chore(kanban): actualizar ${new Date().toISOString()}`, content:b64e(JSON.stringify(data,null,2)), branch:cfg.branch||'main', sha: sha||undefined };
  const put=await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}`,{method:'PUT', headers:{'Accept':'application/vnd.github+json','Content-Type':'application/json','Authorization':'Bearer '+cfg.token}, body: JSON.stringify(body)}); if(!put.ok) throw new Error('Error al guardar: '+put.status); msg('Guardado en GitHub ‚úî') }catch(e){ alert(e.message) }}

btnLoad.onclick = ghLoad; btnSave.onclick = ghSave; btnExport.onclick = ()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kanban.json'; a.click(); URL.revokeObjectURL(url) }

btnNew.onclick = newItem; btnNewBoard.onclick = addBoard; btnRenameBoard.onclick=renameBoard; btnDeleteBoard.onclick=deleteBoard;

function repaint(){ saveLocal(data); renderBoardSelector(); renderFilters(); if(state.tab==='kanban') renderKanban(); if(state.tab==='lista') renderList(); if(state.tab==='cal') renderCalendar(); renderLabels() }

// initial
repaint();
</script>
</body>
</html>
